<!DOCTYPE html>
<html>
<head>
  <title>配置</title>
  <style>
    :root {
      --primary-color: #0071e3;
      --secondary-color: #0063cc;
      --background-color: #f9f9f9;
      --text-color: #333;
      --border-color: #e1e4e8;
      --card-background: white;
      --input-background: white;
      --input-border: #d1d5db;
      --input-focus-border: #0071e3;
      --input-focus-shadow: rgba(0, 113, 227, 0.2);
      --tip-background: #e8f0fe;
      --tip-border: #c2d7ff;
      --tip-text: #174ea6;
      --path-badge-background: #0071e3;
      --path-badge-text: white;
      --selector-background: white;
      --selector-border: #d1d5db;
      --selector-hover: #f3f4f6;
      --selector-option: #0071e3;
      --selector-parent: #4b5563;
    }

    @media (prefers-color-scheme: dark) {
      :root {
        --primary-color: #3b82f6;
        --secondary-color: #60a5fa;
        --background-color: #0f172a;
        --text-color: #e2e8f0;
        --border-color: #334155;
        --card-background: #1e293b;
        --input-background: #1e293b;
        --input-border: #475569;
        --input-focus-border: #3b82f6;
        --input-focus-shadow: rgba(59, 130, 246, 0.2);
        --tip-background: #1e3a8a;
        --tip-border: #3b82f6;
        --tip-text: #93c5fd;
        --path-badge-background: #3b82f6;
        --path-badge-text: white;
        --selector-background: #1e293b;
        --selector-border: #475569;
        --selector-hover: #334155;
        --selector-option: #3b82f6;
        --selector-parent: #94a3b8;
      }
    }

    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif; 
      max-width: 800px; 
      margin: 0 auto; 
      padding: 20px; 
      color: var(--text-color);
      line-height: 1.5;
      background-color: var(--background-color);
    }
    button { 
      padding: 8px 16px; 
      margin-right: 10px; 
      cursor: pointer; 
      background-color: var(--primary-color); 
      color: white; 
      border: none; 
      border-radius: 6px; 
      font-weight: 500;
      transition: background-color 0.2s, transform 0.1s;
    }
    button:hover { 
      background-color: var(--secondary-color); 
    }
    button:active {
      transform: scale(0.98);
    }
    .nav { 
      margin-bottom: 24px; 
      padding-bottom: 12px;
      border-bottom: 1px solid var(--border-color);
    }
    .nav a { 
      text-decoration: none; 
      color: var(--primary-color); 
      font-weight: 500;
      padding: 4px 8px;
      border-radius: 4px;
      transition: background-color 0.2s;
    }
    .nav a:hover {
      background-color: var(--selector-hover);
    }
    .path-item { 
      display: flex; 
      margin-bottom: 12px; 
      align-items: center; 
      flex-wrap: wrap; 
    }
    .path-item input { 
      flex-grow: 1; 
      padding: 10px 12px; 
      margin-right: 10px; 
      min-width: 250px;
      border: 1px solid var(--input-border);
      border-radius: 6px;
      transition: border-color 0.3s, box-shadow 0.3s;
      background-color: var(--input-background);
      color: var(--text-color);
    }
    .path-item input:focus {
      outline: none;
      border-color: var(--input-focus-border);
      box-shadow: 0 0 0 3px var(--input-focus-shadow);
    }
    .path-item button { 
      margin-left: 5px; 
      margin-top: 5px;
      font-size: 0.9em;
    }
    .section { 
      margin-bottom: 24px; 
      border: 1px solid var(--border-color); 
      padding: 20px; 
      border-radius: 8px; 
      position: relative;
      background-color: var(--card-background);
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
      transition: box-shadow 0.3s;
    }
    .section:hover {
      box-shadow: 0 3px 8px rgba(0, 0, 0, 0.08);
    }
    h1 {
      color: var(--text-color);
      margin-bottom: 24px;
    }
    h2 { 
      margin-top: 0; 
      color: var(--text-color);
      font-weight: 600;
      font-size: 1.25rem;
      border-bottom: 1px solid var(--border-color);
      padding-bottom: 8px;
      margin-bottom: 16px;
    }
    .tip { 
      font-size: 0.9em; 
      color: var(--primary-color); 
      margin-left: 10px; 
      display: inline-block; 
      height: 1em; 
    }
    .dir-selector {
        display: none;
        position: absolute;
        background-color: var(--selector-background);
        border: 1px solid var(--selector-border);
        padding: 10px;
        max-height: 220px;
        overflow-y: auto;
        z-index: 10;
        min-width: 280px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        margin-top: 5px;
        left: 15px;
        border-radius: 6px;
    }
    .dir-selector ul { list-style: none; padding: 0; margin: 0; }
    .dir-selector li { 
      padding: 8px 12px; 
      cursor: pointer; 
      white-space: nowrap;
      border-radius: 4px;
      transition: background-color 0.15s;
      color: var(--text-color);
    }
    .dir-selector li:hover { 
      background-color: var(--selector-hover); 
    }
    .dir-selector li.select-option { 
      font-weight: bold; 
      border-top: 1px solid var(--border-color); 
      margin-top: 5px; 
      padding-top: 8px; 
      color: var(--selector-option); 
    }
    .dir-selector li.parent-option { 
      color: var(--selector-parent); 
      font-weight: 500;
    }
    .path-container { 
      margin-bottom: 12px; 
      position: relative; 
    }
    #server-diff-tip {
      background-color: var(--tip-background);
      border: 1px solid var(--tip-border);
      color: var(--tip-text);
    }
    #cwd-display {
      background-color: var(--selector-hover);
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 0.9em;
      margin-bottom: 20px;
    }
    .path-display {
      display: flex;
      align-items: center;
      margin-bottom: 8px;
    }
    .path-label {
      font-weight: 500;
      min-width: 80px;
    }
    .relative-path {
      color: var(--primary-color);
      background-color: var(--tip-background);
      padding: 2px 6px;
      border-radius: 4px;
      font-family: monospace;
      margin-left: 6px;
    }
    .path-mode-switch {
      margin-left: 10px;
      font-size: 0.85em;
      color: var(--text-color);
      cursor: pointer;
      text-decoration: underline;
    }
    .path-mode-container {
      display: flex;
      align-items: center;
      background-color: var(--selector-hover);
      padding: 8px 16px;
      border-radius: 6px;
      margin-bottom: 20px;
      justify-content: space-between;
    }
    .path-mode-info {
      display: flex;
      align-items: center;
    }
    .path-mode-badge {
      background-color: var(--path-badge-background);
      color: var(--path-badge-text);
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 0.8em;
      margin-left: 8px;
    }
  </style>
</head>
<body>
  <div class="nav">
    <a href="index.html">返回主页</a>
  </div>
  <h1>配置</h1>
  <div id="cwd-display" style="margin-bottom: 15px; font-size: 0.9em; color: #555;">当前工作目录: <span id="cwd-path">加载中...</span></div>
  
  <!-- 添加路径模式切换按钮到页面顶部 -->
  <div class="path-mode-container">
    <div class="path-mode-info">
      <span>当前路径显示模式:</span>
      <span class="path-mode-badge" id="current-path-mode">相对路径</span>
    </div>
    <button onclick="togglePathDisplayMode()" id="path-mode-toggle-btn">切换为绝对路径</button>
  </div>

  <div class="section">
    <h2>SQL 文件路径</h2>
    <div class="path-item">
      <input type="text" id="sql-path" placeholder="请手动粘贴 SQL 文件路径或选择目录...">
      <button onclick="showSqlDirectorySelector('.')">选择目录</button>
      <span class="tip" id="sql-path-tip"></span>
    </div>
    <div id="sql-dir-selector" class="dir-selector"></div>
  </div>

  <div class="section" id="output-section">
    <h2>输出路径</h2>
    <div class="path-item">
      <label>Rust 代码输出路径:</label>
      <input type="text" id="rust-output-path" placeholder="请手动粘贴或点击右侧按钮选择目录...">
      <button onclick="showRustDirectorySelector('.')">选择目录</button>
      <span class="tip" id="rust-output-path-tip"></span>
    </div>
    <div id="rust-output-dir-selector" class="dir-selector"></div>

    <div class="path-item" style="margin-top: 15px;">
      <label>前端代码输出路径:</label>
      <input type="text" id="frontend-output-path" placeholder="请手动粘贴或点击右侧按钮选择目录...">
      <button onclick="showFrontendDirectorySelector('.')">选择目录</button>
      <span class="tip" id="frontend-output-path-tip"></span>
    </div>
    <div id="frontend-output-dir-selector" class="dir-selector"></div>
  </div>

  <div>
    <button onclick="saveConfig()">保存配置</button>
    <button onclick="resetConfig()">重置配置</button>
    <span class="tip" id="save-reset-tip"></span>
    <span id="server-diff-tip" style="color: #3949ab; font-weight: bold; margin-left: 10px; background-color: #e8eaf6; padding: 3px 8px; border-radius: 4px; border: 1px solid #9fa8da; display: none;">与配置文件不同步，清保存</span>
  </div>

  <script>
    let config = {
      sqlPaths: "",
      rustOutputPath: "",
      frontendOutputPath: ""
    };
    let initialConfigState = {};
    let serverConfigState = {}; // 存储服务器上的最新配置
    let cwdPath = ""; // 存储当前工作目录
    let showAbsolutePaths = false; // 默认显示相对路径

    function simplePathJoin(...args) {
        return args.filter(Boolean).join('/').replace(/\/+/g, '/').replace(/\/$/, '');
    }

    // 将绝对路径转换为相对路径
    function toRelativePath(absolutePath) {
        if (!absolutePath || !cwdPath || !path.isAbsolute(absolutePath)) return absolutePath;
        try {
            return path.relative(cwdPath, absolutePath) || '.';
        } catch (e) {
            console.error('转换相对路径出错:', e);
            return absolutePath;
        }
    }

    // 将相对路径转换为绝对路径
    function toAbsolutePath(relativePath) {
        if (!relativePath || !cwdPath) return relativePath;
        if (path.isAbsolute(relativePath)) return relativePath;
        try {
            return path.resolve(cwdPath, relativePath);
        } catch (e) {
            console.error('转换绝对路径出错:', e);
            return relativePath;
        }
    }

    // 根据显示模式获取显示路径
    function getDisplayPath(path) {
        return showAbsolutePaths ? toAbsolutePath(path) : path;
    }

    function togglePathDisplayMode() {
        showAbsolutePaths = !showAbsolutePaths;
        
        // 更新UI显示
        const modeText = document.getElementById('current-path-mode');
        if (modeText) {
            modeText.textContent = showAbsolutePaths ? '绝对路径' : '相对路径';
        }
        
        const toggleBtn = document.getElementById('path-mode-toggle-btn');
        if (toggleBtn) {
            toggleBtn.textContent = showAbsolutePaths ? '切换为相对路径' : '切换为绝对路径';
        }
        
        renderConfig();
    }

    function showTip(elementId, message, isError = false) {
        const tipElement = document.getElementById(elementId);
        if (tipElement) {
            tipElement.textContent = message;
            tipElement.style.color = isError ? '#d93025' : '#0071e3';
            setTimeout(() => {
                if (tipElement.textContent === message) {
                   tipElement.textContent = '';
                }
            }, 5000);
        }
    }

    function markChanges() {
        compareWithServerConfig();
    }

    async function fetchAndDisplayCwd() {
        const cwdPathElement = document.getElementById('cwd-path');
        try {
            const response = await fetch('/api/select-path', { method: 'POST' });
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const result = await response.json();
            if (result.success && result.path) {
                cwdPath = result.path;
                cwdPathElement.textContent = result.path;
            } else {
                throw new Error(result.error || '无法获取当前工作目录');
            }
        } catch (error) {
            console.error('获取当前工作目录失败:', error);
            cwdPathElement.textContent = '获取失败';
            cwdPathElement.style.color = 'red';
        }
    }

    async function loadConfig() {
      clearAllTips();
      try {
        const response = await fetch('/api/config/read');
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        config = await response.json();
        config.sqlPaths = typeof config.sqlPaths === 'string' ? config.sqlPaths : '';
        config.rustOutputPath = typeof config.rustOutputPath === 'string' ? config.rustOutputPath : '';
        config.frontendOutputPath = typeof config.frontendOutputPath === 'string' ? config.frontendOutputPath : '';
        
        serverConfigState = {
          sqlPaths: config.sqlPaths,
          rustOutputPath: config.rustOutputPath,
          frontendOutputPath: config.frontendOutputPath
        };
        
        initialConfigState = JSON.stringify(config);
        renderConfig();
        
        const serverDiffTip = document.getElementById('server-diff-tip');
        if (serverDiffTip) {
          serverDiffTip.style.display = 'none';
        }
      } catch (error) {
        console.error('加载配置失败:', error);
        showTip('save-reset-tip', '加载配置失败', true);
      }
    }

    function renderConfig() {
      const sqlPathInput = document.getElementById('sql-path');
      sqlPathInput.value = getDisplayPath(config.sqlPaths) || '';
      sqlPathInput.oninput = handleSqlPathInput;
      sqlPathInput.onchange = handleSqlPathChange;

      const rustOutputPathInput = document.getElementById('rust-output-path');
      rustOutputPathInput.value = getDisplayPath(config.rustOutputPath) || '';
      rustOutputPathInput.oninput = handleRustOutputPathInput;
      rustOutputPathInput.onchange = handleRustOutputPathChange;

      const frontendOutputPathInput = document.getElementById('frontend-output-path');
      frontendOutputPathInput.value = getDisplayPath(config.frontendOutputPath) || '';
      frontendOutputPathInput.oninput = handleFrontendOutputPathInput;
      frontendOutputPathInput.onchange = handleFrontendOutputPathChange;
    }

    function handleSqlPathInput() {
        if (showAbsolutePaths && path.isAbsolute(this.value)) {
            config.sqlPaths = toRelativePath(this.value);
        } else {
            config.sqlPaths = this.value;
        }
        markChanges();
    }
    
    function handleSqlPathChange() {
        if (showAbsolutePaths && path.isAbsolute(this.value)) {
            config.sqlPaths = toRelativePath(this.value);
        } else {
            config.sqlPaths = this.value;
        }
        hideDirectorySelector('sql-dir-selector');
        markChanges();
    }

    function handleRustOutputPathInput() {
        if (showAbsolutePaths && path.isAbsolute(this.value)) {
            config.rustOutputPath = toRelativePath(this.value);
        } else {
            config.rustOutputPath = this.value;
        }
        markChanges();
    }
    
    function handleRustOutputPathChange() {
        if (showAbsolutePaths && path.isAbsolute(this.value)) {
            config.rustOutputPath = toRelativePath(this.value);
        } else {
            config.rustOutputPath = this.value;
        }
        hideDirectorySelector('rust-output-dir-selector');
        markChanges();
    }

    function handleFrontendOutputPathInput() {
        if (showAbsolutePaths && path.isAbsolute(this.value)) {
            config.frontendOutputPath = toRelativePath(this.value);
        } else {
            config.frontendOutputPath = this.value;
        }
        markChanges();
    }
    
    function handleFrontendOutputPathChange() {
        if (showAbsolutePaths && path.isAbsolute(this.value)) {
            config.frontendOutputPath = toRelativePath(this.value);
        } else {
            config.frontendOutputPath = this.value;
        }
        hideDirectorySelector('frontend-output-dir-selector');
        markChanges();
    }

    async function fetchAndDisplayDirs(selectorId, relativePath, onSelectCallback, tipId) {
        clearTip(tipId);
        const selectorElement = document.getElementById(selectorId);
        if (!selectorElement) return;

        selectorElement.innerHTML = '<ul><li>正在加载...</li></ul>';
        selectorElement.style.display = 'block';

        try {
            const response = await fetch(`/api/list-dirs?relativePath=${encodeURIComponent(relativePath)}`);
            if (!response.ok) {
                 const errorData = await response.json().catch(() => ({ message: `HTTP error ${response.status}` }));
                 throw new Error(errorData.message || `HTTP error ${response.status}`);
            }
            const result = await response.json();

            if (result.success) {
                selectorElement.innerHTML = '';
                const ul = document.createElement('ul');

                if (result.parentRelativePath !== null) {
                    const li = document.createElement('li');
                    li.textContent = '.. (上一级)';
                    li.className = 'parent-option';
                    li.onclick = (e) => {
                        e.stopPropagation();
                        fetchAndDisplayDirs(selectorId, result.parentRelativePath, onSelectCallback, tipId);
                    };
                    ul.appendChild(li);
                }

                const selectLi = document.createElement('li');
                const displayPath = result.currentRelativePath === '.' ? '(当前工作目录)' : result.currentRelativePath;
                selectLi.textContent = `选择此目录: ${displayPath}`;
                selectLi.className = 'select-option';
                selectLi.onclick = (e) => {
                    e.stopPropagation();
                    onSelectCallback(result.currentAbsolutePath);
                    hideDirectorySelector(selectorId);
                    showTip(tipId, '已选择目录');
                    markChanges();
                };
                ul.appendChild(selectLi);

                result.directories.forEach(dir => {
                    const li = document.createElement('li');
                    li.textContent = dir.name;
                    li.onclick = (e) => {
                        e.stopPropagation();
                        fetchAndDisplayDirs(selectorId, dir.relativePath, onSelectCallback, tipId);
                    };
                    ul.appendChild(li);
                });

                selectorElement.appendChild(ul);
                selectorElement.style.display = 'block';
            } else {
                 throw new Error(result.error || '无法列出目录');
            }
        } catch (error) {
            console.error('列出目录失败:', error);
            showTip(tipId, `无法列出: ${error.message}`, true);
            selectorElement.innerHTML = `<ul><li style="color:red;">错误: ${error.message}</li></ul>`;
        }
    }

    function showSqlDirectorySelector(relativePath) {
        const selectorId = 'sql-dir-selector';
        const tipId = 'sql-path-tip';
        const onSelect = (selectedAbsolutePath) => {
            console.log(`SQL path selected: ${selectedAbsolutePath}`);
            const relativePath = toRelativePath(selectedAbsolutePath);
            config.sqlPaths = relativePath;
            const sqlPathInput = document.getElementById('sql-path');
            sqlPathInput.value = showAbsolutePaths ? selectedAbsolutePath : relativePath;
            hideDirectorySelector(selectorId);
            markChanges();
        };
        fetchAndDisplayDirs(selectorId, relativePath, onSelect, tipId);
    }

    function showRustDirectorySelector(relativePath) {
        const selectorId = 'rust-output-dir-selector';
        const tipId = 'rust-output-path-tip';
        const onSelect = (selectedAbsolutePath) => {
            console.log(`Rust output directory selected: ${selectedAbsolutePath}`);
            const relativePath = toRelativePath(selectedAbsolutePath);
            config.rustOutputPath = relativePath;
            const rustOutputPathInput = document.getElementById('rust-output-path');
            rustOutputPathInput.value = showAbsolutePaths ? selectedAbsolutePath : relativePath;
            hideDirectorySelector(selectorId);
            markChanges();
        };
        fetchAndDisplayDirs(selectorId, relativePath, onSelect, tipId);
    }

    function showFrontendDirectorySelector(relativePath) {
        const selectorId = 'frontend-output-dir-selector';
        const tipId = 'frontend-output-path-tip';
        const onSelect = (selectedAbsolutePath) => {
            console.log(`Frontend output directory selected: ${selectedAbsolutePath}`);
            const relativePath = toRelativePath(selectedAbsolutePath);
            config.frontendOutputPath = relativePath;
            const frontendOutputPathInput = document.getElementById('frontend-output-path');
            frontendOutputPathInput.value = showAbsolutePaths ? selectedAbsolutePath : relativePath;
            hideDirectorySelector(selectorId);
            markChanges();
        };
        fetchAndDisplayDirs(selectorId, relativePath, onSelect, tipId);
    }

    function hideDirectorySelector(selectorId) {
        const selectorElement = document.getElementById(selectorId);
        if (selectorElement) {
            selectorElement.style.display = 'none';
        }
    }

    document.addEventListener('click', function(event) {
        const clickedSelector = event.target.closest('.dir-selector');
        const clickedButton = event.target.closest('button[onclick^="showDirectorySelector"], button[onclick^="showSqlDirectorySelector"]');

        if (!clickedSelector && !clickedButton) {
            document.querySelectorAll('.dir-selector').forEach(sel => sel.style.display = 'none');
        }
    });

    async function saveConfig() {
      clearAllTips();
      config.sqlPaths = document.getElementById('sql-path').value;
      config.rustOutputPath = document.getElementById('rust-output-path').value;
      config.frontendOutputPath = document.getElementById('frontend-output-path').value;

      console.log("Attempting to save config:", JSON.stringify(config));

      try {
        const response = await fetch('/api/config/write', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(config)
        });
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        const result = await response.json();
        if (result.success) {
           showTip('save-reset-tip', '配置已保存');
           initialConfigState = JSON.stringify(config);
           
           serverConfigState = {
             sqlPaths: config.sqlPaths,
             rustOutputPath: config.rustOutputPath,
             frontendOutputPath: config.frontendOutputPath
           };
           
           const serverDiffTip = document.getElementById('server-diff-tip');
           if (serverDiffTip) {
             serverDiffTip.style.display = 'none';
           }
        } else {
           throw new Error(result.error || '保存配置失败');
        }
      } catch (error) {
        console.error('保存配置失败:', error);
        showTip('save-reset-tip', `保存失败: ${error.message}`, true);
      }
    }

    async function resetConfig() {
      clearAllTips();
      if (confirm('确定要重置所有配置吗？此操作也会清除未保存的更改。')) {
        console.log("Attempting to reset config.");
        try {
          const response = await fetch('/api/config/reset', { method: 'POST' });
           if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
          config = await response.json();
          initialConfigState = JSON.stringify(config);
          renderConfig();
          showTip('save-reset-tip', '配置已重置');
          
          serverConfigState = {
            sqlPaths: config.sqlPaths,
            rustOutputPath: config.rustOutputPath,
            frontendOutputPath: config.frontendOutputPath
          };
          
          const serverDiffTip = document.getElementById('server-diff-tip');
          if (serverDiffTip) {
            serverDiffTip.style.display = 'none';
          }
        } catch (error) {
          console.error('重置配置失败:', error);
          showTip('save-reset-tip', '重置失败', true);
        }
      }
    }

    function clearTip(elementId) {
        const tipElement = document.getElementById(elementId);
        if (tipElement) {
            tipElement.textContent = '';
        }
    }

    function clearAllTips() {
        document.querySelectorAll('.tip').forEach(tip => tip.textContent = '');
    }

    function compareWithServerConfig() {
      const tipElement = document.getElementById('server-diff-tip');
      
      const currentConfig = {
        sqlPaths: config.sqlPaths,
        rustOutputPath: config.rustOutputPath,
        frontendOutputPath: config.frontendOutputPath
      };
      
      const currentStr = JSON.stringify(currentConfig);
      const serverStr = JSON.stringify(serverConfigState);
      
      console.log("与服务器配置比较:", 
                  currentStr === serverStr ? "相同" : "不同");
      
      if (currentStr !== serverStr && tipElement) {
        tipElement.style.display = 'inline-block';
      } else if (tipElement) {
        tipElement.style.display = 'none';
      }
    }

    const path = {
        isAbsolute: function(p) {
            return p.startsWith('/') || /^[A-Za-z]:/.test(p);
        },
        relative: function(from, to) {
            if (!this.isAbsolute(from) || !this.isAbsolute(to)) return to;
            
            const fromParts = from.split(/[\/\\]/).filter(Boolean);
            const toParts = to.split(/[\/\\]/).filter(Boolean);
            
            let i = 0;
            for (; i < Math.min(fromParts.length, toParts.length); i++) {
                if (fromParts[i] !== toParts[i]) break;
            }
            
            const upCount = fromParts.length - i;
            const relativeParts = Array(upCount).fill('..').concat(toParts.slice(i));
            
            return relativeParts.join('/') || '.';
        },
        resolve: function(from, to) {
            if (this.isAbsolute(to)) return to;
            
            return from.replace(/\/?$/, '/') + to;
        }
    };

    fetchAndDisplayCwd();
    loadConfig();

    window.addEventListener('beforeunload', (event) => {
      const currentConfig = {
        sqlPaths: config.sqlPaths,
        rustOutputPath: config.rustOutputPath,
        frontendOutputPath: config.frontendOutputPath
      };
      const currentStr = JSON.stringify(currentConfig);
      const serverStr = JSON.stringify(serverConfigState);
      
      if (currentStr !== serverStr) {
        event.preventDefault();
        event.returnValue = '';
      }
    });
  </script>
</body>
</html>

