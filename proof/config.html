<!DOCTYPE html>
<html>
<head>
  <title>配置</title>
  <style>
    body { font-family: sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
    button { padding: 10px 15px; margin-right: 10px; }
    .nav { margin-bottom: 20px; }
    .nav a { text-decoration: none; color: #0071e3; }
    .path-item { display: flex; margin-bottom: 10px; align-items: center; }
    .path-item input { flex-grow: 1; padding: 8px; margin-right: 10px; }
    .path-item button { margin-left: 5px; }
    .section { margin-bottom: 20px; border: 1px solid #ddd; padding: 15px; border-radius: 5px; }
    h2 { margin-top: 0; }
  </style>
</head>
<body>
  <div class="nav">
    <a href="index.html">返回主页</a>
  </div>
  <h1>配置</h1>

  <div class="section">
    <h2>SQL 文件路径</h2>
    <div id="sql-paths-container">
      <!-- SQL路径将在这里动态显示 -->
    </div>
    <button onclick="addSqlPath()">添加 SQL 路径</button>
  </div>

  <div class="section">
    <h2>输出路径</h2>
    <div class="path-item">
      <input type="text" id="output-path" placeholder="选择输出目录..." readonly>
      <button onclick="selectPath('directory', 'output')">浏览...</button>
    </div>
  </div>

  <div>
    <button onclick="saveConfig()">保存配置</button>
    <button onclick="resetConfig()">重置配置</button>
  </div>

  <script>
    let config = {
      sqlPaths: [],
      outputPath: ""
    };

    // 初始化加载配置
    async function loadConfig() {
      try {
        const response = await fetch('/api/config/read');
        config = await response.json();
        renderConfig();
      } catch (error) {
        console.error('加载配置失败:', error);
        alert('加载配置失败');
      }
    }

    // 渲染配置到界面
    function renderConfig() {
      // 渲染 SQL 路径
      const sqlPathsContainer = document.getElementById('sql-paths-container');
      sqlPathsContainer.innerHTML = '';
      
      config.sqlPaths.forEach((path, index) => {
        const pathItem = document.createElement('div');
        pathItem.className = 'path-item';
        pathItem.innerHTML = `
          <input type="text" value="${path}" readonly data-index="${index}">
          <button onclick="selectPath('file', 'sql', ${index})">浏览...</button>
          <button onclick="removeSqlPath(${index})">删除</button>
        `;
        sqlPathsContainer.appendChild(pathItem);
      });

      // 渲染输出路径
      document.getElementById('output-path').value = config.outputPath || '';
    }

    // 添加 SQL 路径
    function addSqlPath() {
      config.sqlPaths.push('');
      renderConfig();
      // 自动触发新添加路径的选择对话框
      const newIndex = config.sqlPaths.length - 1;
      selectPath('file', 'sql', newIndex);
    }

    // 移除 SQL 路径
    function removeSqlPath(index) {
      config.sqlPaths.splice(index, 1);
      renderConfig();
    }

    // 选择路径
    async function selectPath(type, target, index) {
      try {
        const response = await fetch('/api/select-path', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ type })
        });
        
        const result = await response.json();
        
        if (result.success && result.path) {
          if (target === 'sql') {
            config.sqlPaths[index] = result.path;
          } else if (target === 'output') {
            config.outputPath = result.path;
          }
          renderConfig();
        } else {
          console.error('选择路径失败:', result.error || '未知错误');
          alert('选择路径失败');
        }
      } catch (error) {
        console.error('选择路径请求失败:', error);
        alert('选择路径请求失败');
      }
    }

    // 保存配置
    async function saveConfig() {
      try {
        await fetch('/api/config/write', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(config)
        });
        alert('配置已保存');
      } catch (error) {
        console.error('保存配置失败:', error);
        alert('保存配置失败');
      }
    }

    // 重置配置
    async function resetConfig() {
      if (confirm('确定要重置所有配置吗？')) {
        try {
          const response = await fetch('/api/config/reset', {
            method: 'POST'
          });
          config = await response.json();
          renderConfig();
          alert('配置已重置');
        } catch (error) {
          console.error('重置配置失败:', error);
          alert('重置配置失败');
        }
      }
    }

    // 页面加载时读取配置
    loadConfig();
  </script>
</body>
</html>